@{
    ViewData["Title"] = "Servicios";
}
<h1>@ViewData["Title"]</h1>

<div class="row">
    <div class="col-sm-12">

        <!--Inicio tarjeta-->
        <div class="card">
            <div class="card-header">Servicios</div>
            <div class="card-body">

                <button class="btn btn-success" id="btnNuevo">Nuevo Servicio</button>

                <hr />

                <table class="table table-striped" id="tblServicio">
                    <thead>
                        <tr>
                            <th>Id</th>
                            <th>Nombre</th>
                            <th>Costo</th>
                            <th>Tipo</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>

            </div>
        </div>
        <!--Fin tarjeta-->

    </div>
</div>



<!--Inicio Modal-->
<div class="modal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalle Servicio</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="txtIdServicio" value="0" />
                <div class="mb-2">
                    <label>Nombre</label>
                    <input type="text" class="form-control" id="txtNombreServicio" />
                </div>
                <div class="mb-2">
                    <label>Periodo Servicio</label>
                    <input type="text" class="form-control" id="txtPeriodoServicio" />
                </div>
                <div class="mb-2">
                    <label>Tipo</label>
                    <input type="text" class="form-control" id="txtTipoServicio" />
                </div>
                <div class="mb-2">
                    <label>Costo</label>
                    <input type="text" class="form-control" id="txtCostoServicio" />
                </div>
                <div class="mb-2">
                    <label>Detalle</label>
                    <input type="text" class="form-control" id="txtDetalleServicio" />
                </div>
                <div class="mb-2">
                    <label>Estado</label>
                    <input type="text" class="form-control" id="txtEstadoServicio" />
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="btnGuardar">Guardar</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>
<!--Fin Modal-->


@section Scripts
{
    <script>
        $(document).ready(() => {
            listaServicios();
            // alert("Iniciando Servicios");
        })
        //modelo que seteara valores vacios iniciales al formulario
        const modeloBase =
        {
            idServicio:0,
            nombreServicio:"",
            periodoServicio:"",
            tipoServicio:"",
            costoServicio:"",
            detalleServicio:"",
            estadoServicio:""
        }

        //funcion que recibe un modelo para cargar en campos de modal
        function showModal(modelo) {
            $("#txtIdServicio").val(modelo.idServicio);
            $("#txtNombreServicio").val(modelo.nombreServicio);
            $("#txtPeriodoServicio").val(modelo.periodoServicio);
            $("#txtTipoServicio").val(modelo.tipoServicio);
            $("#txtCostoServicio").val(modelo.costoServicio);
            $("#txtDetalleServicio").val(modelo.detalleServicio);
            $("#txtEstadoServicio").val(modelo.estadoServicio);
            $('.modal').modal('show');
        }
        // modeloBase el modal con el boton
        $("#btnNuevo").click(() => {
            showModal(modeloBase);
        })

        //funcion para mostrar todos los servicios
        function listaServicios() 
        {
            

            $.ajax({
                url: "../Home/listarServicios",
                type: "GET",
                dataType: "json",
                success: function (dataJson) {
                    // Limpiar tabla
                    $("#tblServicio tbody").html("");

                    // Agregar filas a la tabla
                    dataJson.forEach(function (item) {
                        $("#tblServicio tbody").append(
                            $("<tr>").append(
                                $("<td>").text(item.idServicio),
                                $("<td>").text(item.nombreServicio),
                                $("<td>").text(item.costoServicio),
                                $("<td>").text(item.tipoServicio),
                                $("<td>").text(item.estadoServicio),
                                $("<td>").append(
                                    $("<button>").addClass("btn btn-success btn-sm me-2 btn-ver").data("modelo", item).text("Ver"),
                                    $("<button>").addClass("btn btn-primary btn-sm me-2 btn-editar").data("modelo", item).text("Editar"),
                                    $("<button>").addClass("btn btn-danger btn-sm btn-eliminar").data("id", item.idServicio).text("Eliminar")
                                )
                            )
                        );
                    });
                },
                error: function (xhr, status, error) {
                    console.error("Error en la solicitud AJAX:", status, error);
                }
            });
        }

        //funcion que se dispara al hacer click en el btn guardar para guardar un nuevo servicio
        $("#btnGuardar").click(() => {
            let nuevoModelo = modeloBase;
            nuevoModelo["idServicio"] = $("#txtIdServicio").val();
            nuevoModelo["nombreServicio"] = $("#txtNombreServicio").val();
            nuevoModelo["periodoServicio"] = $("#txtPeriodoServicio").val();
            nuevoModelo["tipoServicio"] = $("#txtTipoServicio").val();
            nuevoModelo["costoServicio"] = $("#txtCostoServicio").val();
            nuevoModelo["detalleServicio"] = $("#txtDetalleServicio").val();
            nuevoModelo["estadoServicio"] = $("#txtEstadoServicio").val();

            if ($("#txtIdServicio").val()==0) 
            {
                $.ajax({
                    url: "../Home/insertarServicio",
                    type: "POST",
                    contentType: "application/json;charset=utf-8",
                    data: JSON.stringify(nuevoModelo),
                    success: function (dataJson) {
                        if (dataJson.valor) {
                            alert("Servicio registrado");
                            $('.modal').modal('hide');
                            listaServicios();
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("Error en la solicitud AJAX:", status, error);
                    }
                });

            }
            else if ($("#txtIdServicio").val() != 0) //actualizamos el registro de nuestro cliente
            {
                $.ajax({
                    url: "../Home/actualizarServicio",
                    type: "PUT",
                    contentType: "application/json;charset=utf-8",
                    data: JSON.stringify(nuevoModelo),
                    success: function (dataJson) {
                        if (dataJson.valor) {
                            alert("Servicio Actualizado Correctamente");
                            $('.modal').modal('hide');
                            listaServicios();
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("Error en la solicitud AJAX:", status, error);
                    }
                });
            }
        })

        // Editar un servicio cargado datos a modal desde btn editar
        $("#tblServicio tbody").on("click", ".btn-ver", function () {
            let servicio = $(this).data("modelo");
            console.log(servicio);
            showModal(servicio);
        })
        // Editar un servicio cargado datos a modal desde btn editar
        $("#tblServicio tbody").on("click", ".btn-editar", function () {
            let servicio = $(this).data("modelo");
            console.log(servicio);
            showModal(servicio);
        })


        //metodo para eliminar servicio
        $("#tblServicio tbody").on("click", ".btn-eliminar", function () {
            let idServicio = $(this).data("id");
            console.log(idServicio);
            let resultado = window.confirm("¿Desea eliminar el Servicio?");
            if (resultado) {
             

                $.ajax({
                    url: "../Home/deleteServicio",
                    type: "DELETE",
                    data: { id: idServicio },
                    success: function (dataJson) {
                        if (dataJson.valor) {
                            alert("Servicio Eliminado Correctamente");
                            listaServicios();
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("Error en la solicitud AJAX:", status, error);
                    }
                });
            }
        })
    </script>
}   